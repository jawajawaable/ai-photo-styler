<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satriq - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #6366f1;
            color: #6366f1;
        }

        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #94a3b8;
        }

        .tab-inactive:hover {
            color: #e2e8f0;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen">
    <div id="app"></div>

    <table class="w-full text-left text-sm text-slate-400">
        <thead class="bg-slate-900 uppercase text-xs">
            <tr>
                <th class="px-6 py-4">ID</th>
                <th class="px-6 py-4">Title</th>
                <th class="px-6 py-4 text-right">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
            ${categories.map(c => `<tr>
                <td class="px-6 py-4 text-indigo-400">${c.id}</td>
                <td class="px-6 py-4 text-white">${c.title}</td>
                <td class="px-6 py-4 text-right"><button onclick='openEditCategoryModal(${JSON.stringify(c).replace(/'
                        /g, "&#39;" )})' class="text-indigo-400 mr-2">Edit</button><button
                        onclick="deleteCategory('${c.id}')" class="text-red-400">Delete</button></td>
            </tr>`).join('')}
        </tbody>
    </table>
    </div>`;
    }

    function renderAnalyticsTab() {
    return `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Styles</h3>
            <div class="h-64"><canvas id="stylesChart"></canvas></div>
        </div>
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Daily</h3>
            <div class="h-64"><canvas id="dailyChart"></canvas></div>
        </div>
    </div>
    <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
        <h3 class="text-lg font-bold mb-4">Top Users</h3>
        <div id="usersTableBody">Loading...</div>
    </div>
    `;
    }

    function renderCleanupTab() {
    return `
    <div class="max-w-xl mx-auto bg-slate-800 p-8 rounded-xl border border-red-500/30">
        <h2 class="text-xl font-bold text-red-400 mb-6">Storage Cleanup</h2>
        <div class="grid grid-cols-3 gap-4">
            <button onclick="handleCleanup(3)"
                class="p-4 bg-slate-900 border border-slate-700 rounded-xl hover:border-red-500">3 Days</button>
            <button onclick="handleCleanup(7)"
                class="p-4 bg-slate-900 border border-slate-700 rounded-xl hover:border-indigo-500">7 Days</button>
            <button onclick="handleCleanup(30)"
                class="p-4 bg-slate-900 border border-slate-700 rounded-xl hover:border-emerald-500">30 Days</button>
        </div>
    </div>`;
    }

    function renderCreditsTab() {
    return `
    <div class="max-w-xl mx-auto bg-slate-800 p-8 rounded-xl border border-emerald-500/30">
        <h2 class="text-xl font-bold text-emerald-400 mb-4">Manage Credits</h2>
        <form onsubmit="handleAddCredits(event)" class="space-y-4">
            <input type="text" id="targetUserId" placeholder="User UUID" required
                class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white">
            <input type="number" id="creditAmount" placeholder="Amount (e.g. 50)" required
                class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white">
            <button type="submit"
                class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold text-white">Update
                Credits</button>
        </form>
    </div>`;
    }

    function renderUsersTab() {
    return `
    <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <h2 class="text-xl font-bold">User Storage Management</h2>
            <button onclick="loadUserStats(); renderApp()" class="text-indigo-400 hover:text-white">Refresh</button>
        </div>
        <table class="w-full text-left text-sm text-slate-400">
            <thead class="bg-slate-900 uppercase text-xs">
                <tr>
                    <th class="px-6 py-4">User ID</th>
                    <th class="px-6 py-4 text-center">Images (Jobs)</th>
                    <th class="px-6 py-4">Last Active</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
                ${userStats.length ? userStats.map(u => `
                <tr class="hover:bg-slate-700/50">
                    <td class="px-6 py-4 font-mono text-xs text-indigo-400">
                        ${u.user_id}
                        <button onclick="navigator.clipboard.writeText('${u.user_id}')"
                            class="ml-2 text-slate-500 hover:text-white" title="Copy ID">üìã</button>
                    </td>
                    <td class="px-6 py-4 text-center text-white font-bold">${u.job_count}</td>
                    <td class="px-6 py-4 text-xs">${u.last_active ? new Date(u.last_active).toLocaleDateString() : '-'}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="handleDeleteUserFiles('${u.user_id}')"
                            class="px-3 py-1 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white rounded border border-red-500/20 text-xs transition-colors">
                            üóëÔ∏è Delete All Images
                        </button>
                    </td>
                </tr>
                `).join('') : '<tr>
                    <td colspan="4" class="p-8 text-center">No users found</td>
                </tr>'}
            </tbody>
        </table>
    </div>`;
    }

    // --- Modals ---
    function renderStyleModal() {
    return `
    <div id="styleModal"
        class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-slate-700 p-6">
            <div class="flex justify-between mb-6">
                <h2 id="styleModalTitle" class="text-xl font-bold">Edit Style</h2><button
                    onclick="closeModals()">‚úï</button>
            </div>
            <form id="styleForm" onsubmit="handleStyleSubmit(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div id="styleImagePreview" class="h-32 bg-slate-900 rounded mb-2 overflow-hidden"></div>
                        <input type="file" id="styleImageUpload" class="text-sm text-slate-400">
                    </div>
                    <div class="space-y-3">
                        <input name="style_id" placeholder="ID" required
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                        <input name="name" placeholder="Name" required
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                        <select name="category"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded"></select>
                    </div>
                </div>
                <textarea name="description" rows="2" placeholder="Description"
                    class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded"></textarea>

                <!-- Carousel Section -->
                <div class="bg-slate-900/50 p-4 rounded border border-slate-700">
                    <h3 class="text-sm font-bold text-yellow-500 mb-2">üé† Carousel Settings</h3>
                    <textarea name="short_description" rows="2" placeholder="Carousel Marketing Text"
                        class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded mb-2 text-sm"></textarea>
                    <label class="flex items-center gap-2"><input type="checkbox" name="featured_in_carousel"> Show in
                        Carousel</label>
                </div>

                <textarea name="prompt_modifier" rows="2" placeholder="Prompt Modifier"
                    class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded font-mono text-xs"></textarea>
                <div class="grid grid-cols-3 gap-4">
                    <input name="icon" placeholder="Icon"
                        class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                    <input type="color" name="color" class="w-full h-10 bg-slate-900 border border-slate-700 rounded">
                    <input type="number" name="sort_order"
                        class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                </div>
                <label class="flex items-center gap-2"><input type="checkbox" name="requires_two_photos"> Requires 2
                    Photos</label>

                <div class="flex gap-4 pt-4 border-t border-slate-700">
                    <button type="button" id="styleDeleteBtn" onclick="deleteStyle(editingStyle.id)"
                        class="text-red-400">Delete</button>
                    <div class="flex-1"></div>
                    <button type="button" onclick="closeModals()" class="text-slate-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 px-6 py-2 rounded text-white font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>`;
    }

    function renderCategoryModal() {
    return `
    <div id="categoryModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-xl w-full max-w-md p-6 border border-slate-700">
            <div class="flex justify-between mb-4">
                <h2 id="categoryModalTitle" class="text-xl font-bold">Category</h2><button
                    onclick="closeModals()">‚úï</button>
            </div>
            <form id="categoryForm" onsubmit="handleCategorySubmit(event)" class="space-y-4">
                <input name="id" placeholder="ID" required
                    class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                <input name="title" placeholder="Title" required
                    class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                <input name="description" placeholder="Description"
                    class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                <div class="grid grid-cols-2 gap-4">
                    <input name="icon" placeholder="Icon"
                        class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                    <input type="number" name="sort_order"
                        class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded">
                </div>
                <div class="flex gap-4 pt-4"><button type="button" id="categoryDeleteBtn"
                        onclick="deleteCategory(editingCategory.id)" class="text-red-400">Delete</button>
                    <div class="flex-1"></div><button type="submit"
                        class="bg-indigo-600 px-6 py-2 rounded font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>`;
    }

    function showStyleModal(data) {
    const form = document.getElementById('styleForm');
    const d = data || {};
    form.style_id.value = d.style_id || '';
    form.style_id.disabled = !!editingStyle;
    form.name.value = d.name || '';
    form.description.value = d.description || '';
    form.short_description.value = d.short_description || '';
    form.prompt_modifier.value = d.prompt_modifier || '';
    form.icon.value = d.icon || '';
    form.color.value = d.color || '#6366f1';
    form.sort_order.value = d.sort_order || 0;
    form.requires_two_photos.checked = d.requires_two_photos || false;
    form.featured_in_carousel.checked = d.featured_in_carousel || false;

    const catSelect = form.category;
    catSelect.innerHTML = categories.map(c => `<option value="${c.id}" ${d.category===c.id ? 'selected' : '' }>
        ${c.title}</option>`).join('');

    document.getElementById('styleImagePreview').innerHTML = d.image_url ? `<img src="${d.image_url}"
        class="w-full h-full object-cover">` : '';
    document.getElementById('styleModalTitle').textContent = editingStyle ? 'Edit Style' : 'New Style';
    document.getElementById('styleDeleteBtn').style.display = editingStyle ? 'block' : 'none';
    document.getElementById('styleModal').classList.remove('hidden');
    }

    function showCategoryModal(data) {
    const form = document.getElementById('categoryForm');
    const d = data || {};
    form.id.value = d.id || '';
    form.id.readOnly = !!editingCategory;
    form.title.value = d.title || '';
    form.description.value = d.description || '';
    form.icon.value = d.icon || '';
    form.sort_order.value = d.sort_order || 0;
    document.getElementById('categoryModalTitle').textContent = editingCategory ? 'Edit Category' : 'New Category';
    document.getElementById('categoryDeleteBtn').style.display = editingCategory ? 'block' : 'none';
    document.getElementById('categoryModal').classList.remove('hidden');
    }

    function initCharts() {
    if (!jobs.length) return document.getElementById('usersTableBody').innerHTML = 'No data';

    // Users
    const userCounts = {};
    jobs.forEach(j => userCounts[j.user_id] = (userCounts[j.user_id] || 0) + 1);
    const sortedUsers = Object.entries(userCounts).sort(([, a], [, b]) => b - a).slice(0, 50);

    document.getElementById('usersTableBody').innerHTML = `
    <table class="w-full text-left text-sm text-slate-400">
        ${sortedUsers.map(([uid, c], i) => `<tr>
            <td class="p-2">#${i + 1}</td>
            <td class="p-2 font-mono text-xs text-indigo-400">${uid}</td>
            <td class="p-2 text-right text-white font-bold">${c}</td>
        </tr>`).join('')}
    </table>`;

    // Charts
    const styleCounts = {}; jobs.forEach(j => styleCounts[j.style_name || 'U'] = (styleCounts[j.style_name || 'U'] || 0)
    + 1);
    const sortedStyles = Object.entries(styleCounts).sort(([, a], [, b]) => b - a).slice(0, 10);

    new Chart(document.getElementById('stylesChart'), {
    type: 'bar',
    data: { labels: sortedStyles.map(s => s[0]), datasets: [{ label: 'Uses', data: sortedStyles.map(s => s[1]),
    backgroundColor: '#6366f1' }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const daily = {};
    for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i);
    daily[d.toISOString().split('T')[0]] = 0; }
    jobs.forEach(j => { const k = new Date(j.created_at).toISOString().split('T')[0]; if (daily[k] !== undefined)
    daily[k]++; });

    new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: { labels: Object.keys(daily).map(d => d.slice(5)), datasets: [{ label: 'Jobs', data: Object.values(daily),
    borderColor: '#10b981', tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    }

    init();
    </script>
</body>

</html>